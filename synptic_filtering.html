<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>How Synapses Filter Signals — Mossy Fiber → CA3 (Beginner Interactive)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#ffffff; --fg:#111827; --muted:#374151; --accent:#0d6efd; --border:#e5e7eb; --panel:#ffffff;
    }
    body{ background:var(--bg); color:var(--fg); }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; }
    .subtitle{ color:var(--muted); }
    .kbd{ background:#f3f4f6; border:1px solid #e5e7eb; padding:.15rem .4rem; border-radius:.35rem; }
    .legend-dot{ display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:6px; vertical-align:middle; }
    .spike{ height:18px; width:2px; background:#111827; display:inline-block; margin:0 1px; }
    .help{ font-size:.95rem; color:#374151; }
    .section-title{ font-weight:700; font-size:1.15rem; }
    .vis-hint{ font-size:.95rem; border-left:4px solid var(--accent); padding-left:.6rem; }
    .btn-contrast{ font-weight:600; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="row g-4 align-items-stretch">
        

      <!-- LEFT: CONTROLS & EXPLANATION (BEGINNER-FIRST) -->
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h2 class="mb-1">How Synapses Filter Signals</h2>
            <div class="subtitle mb-3">Mossy fiber → CA3 feed‑forward circuit (beginner interactive)</div>

            <p class="help mb-3">Goal: explore how <strong>short‑term plasticity (STP)</strong> at mossy‑fiber synapses makes the circuit <em>gate background</em> but <em>pass bursts</em>. You only need the controls in <strong>Beginner</strong> below. Open <strong>Advanced</strong> if you’re curious.</p>

            <div class="mb-2 section-title">Beginner</div>
            <div class="help mb-2">These three sliders are enough to see the key idea.</div>

            <label class="form-label fw-semibold">Presynaptic rate (Hz): <span id="rateVal" class="kbd">10</span></label>
            <input id="rate" type="range" min="1" max="120" step="1" value="10" class="form-range" aria-label="Presynaptic rate in Hertz">

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label fw-semibold">Duration (s): <span id="durVal" class="kbd">3.0</span></label>
                <input id="dur" type="range" min="1" max="10" step="0.5" value="3" class="form-range" aria-label="Duration in seconds">
              </div>
              <div class="col-6">
                <label class="form-label fw-semibold">Burst boost (last 0.5 s): <span id="burstVal" class="kbd">1×</span></label>
                <input id="burst" type="range" min="1" max="8" step="1" value="1" class="form-range" aria-label="Burst boost factor">
              </div>
            </div>

            <div class="d-grid gap-2 my-3">
              <button id="presetBg" class="btn btn-outline-secondary btn-contrast">Example: Background (noise gating)</button>
              <button id="presetBurst" class="btn btn-outline-primary btn-contrast">Example: Burst (gate opens)</button>
            </div>

            <div class="d-flex gap-2">
              <button id="run" class="btn btn-primary btn-contrast">Run</button>
              <button id="reset" class="btn btn-outline-dark btn-contrast">Reset</button>
            </div>

            <hr class="my-4">

            <details>
              <summary class="section-title">Advanced (optional)</summary>
              <p class="help mt-2">We use a simple <strong>Tsodyks–Markram</strong> synapse. Release on a spike ≈ <code>u × R</code>, where <em>u</em> is release probability and <em>R</em> is available resources.</p>

              <div class="fw-semibold mt-2">PC synapse (facilitating → burst detector)</div>
              <label class="form-label">Baseline U<sub>PC</sub>: <span id="UpcVal" class="kbd">0.15</span></label>
              <input id="Upc" type="range" min="0.02" max="0.6" step="0.01" value="0.15" class="form-range">
              <label class="form-label">Facilitation τ<sub>PC</sub> (ms): <span id="tfpcVal" class="kbd">600</span></label>
              <input id="tfpc" type="range" min="0" max="1500" step="50" value="600" class="form-range">
              <label class="form-label">Recovery τ<sub>PC</sub> (ms): <span id="trpcVal" class="kbd">100</span></label>
              <input id="trpc" type="range" min="20" max="2000" step="20" value="100" class="form-range">
              <label class="form-label">PC synaptic weight: <span id="wpcVal" class="kbd">1.0</span></label>
              <input id="wpc" type="range" min="0.1" max="5" step="0.1" value="1.0" class="form-range">

              <div class="fw-semibold mt-3">IN synapse (reliable / mildly depressing)</div>
              <label class="form-label">Baseline U<sub>IN</sub>: <span id="UinVal" class="kbd">0.45</span></label>
              <input id="Uin" type="range" min="0.05" max="0.9" step="0.01" value="0.45" class="form-range">
              <label class="form-label">Facilitation τ<sub>IN</sub> (ms): <span id="tfinVal" class="kbd">50</span></label>
              <input id="tfin" type="range" min="0" max="1500" step="50" value="50" class="form-range">
              <label class="form-label">Recovery τ<sub>IN</sub> (ms): <span id="trinVal" class="kbd">800</span></label>
              <input id="trin" type="range" min="20" max="2000" step="20" value="800" class="form-range">
              <label class="form-label">IN synaptic weight: <span id="winVal" class="kbd">1.0</span></label>
              <input id="win" type="range" min="0.1" max="5" step="0.1" value="1.0" class="form-range">

              <div class="fw-semibold mt-3">Feed‑forward inhibition to PC</div>
              <label class="form-label">IN→PC inhibitory weight: <span id="gipVal" class="kbd">1.6</span></label>
              <input id="gip" type="range" min="0" max="5" step="0.1" value="1.6" class="form-range">
              <label class="form-label">Inhibitory delay (ms): <span id="dlyVal" class="kbd">2</span></label>
              <input id="delay" type="range" min="0" max="10" step="1" value="2" class="form-range">
            </details>

            <hr class="my-4">
            <div class="vis-hint">
              <div><strong>What to look for</strong></div>
              <ul class="mb-2">
                <li><strong>Background</strong>: IN spikes appear even at low rates → inhibition keeps PC quiet.</li>
                <li><strong>Burst</strong>: Facilitation at PC grows → PC spikes overcome inhibition.</li>
              </ul>
              <div class="help">This is the core idea of <em>target‑cell specific filtering</em>.</div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: VISUALISATIONS -->
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-body">
            <h3 class="mb-1">Outputs</h3>
            <div class="subtitle mb-3">Simple leaky integrate‑and‑fire neurons. Threshold=1, reset=0.</div>

            <div class="mb-2">
              <span class="legend-dot" style="background:#3b82f6"></span>PC membrane potential (V<sub>m</sub>)
              &nbsp; <span class="legend-dot" style="background:#ef4444"></span>IN membrane potential
            </div>
            <canvas id="chartVm" height="230" aria-label="Membrane potentials over time"></canvas>

            <div class="row g-3 mt-3">
              <div class="col-md-6">
                <div class="p-2 border rounded">
                  <div class="fw-semibold">PC spikes</div>
                  <div id="pcSpikes" class="help"></div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="p-2 border rounded">
                  <div class="fw-semibold">IN spikes</div>
                  <div id="inSpikes" class="help"></div>
                </div>
              </div>
            </div>

            <hr>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="mb-1 fw-semibold">Excitatory drive (∝ release u×R)</div>
                <canvas id="chartSyn" height="170"></canvas>
              </div>
              <div class="col-md-6">
                <div class="mb-1 fw-semibold">Inhibitory drive to PC</div>
                <canvas id="chartInh" height="170"></canvas>
              </div>
            </div>

            <hr>
            <div class="help">
              <strong>Glossary</strong>: <em>Facilitation</em> = release probability rises during a burst. <em>Depression</em> = resources get used up. <em>Feed‑forward inhibition</em> = interneuron activated by the same input suppresses the pyramidal cell.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
// -------- Beginner-friendly model (same core as before) --------
function poissonSpikes(rateHz, T_ms, burstFactor=1, burstWindow_ms=500) {
  const spikes = []; const dt=1; const base = rateHz/1000; const burstStart=Math.max(0, T_ms-burstWindow_ms);
  for (let t=0;t<T_ms;t+=dt){ const lam = (t>=burstStart)? base*burstFactor : base; if (Math.random()<lam) spikes.push(t); }
  return spikes;
}

function TM_on_spike(state, params, isi_ms){
  const {U0, tau_rec, tau_facil} = params; let {R,u}=state;
  const expRec=Math.exp(-isi_ms/Math.max(1,tau_rec));
  const expFac=Math.exp(-isi_ms/Math.max(1, tau_facil||1e9));
  R = 1 - (1-R)*expRec; u = (tau_facil>0)? (U0 + (u-U0)*expFac) : U0;
  const release = u*R; R -= release; u = (tau_facil>0)? (u + U0*(1-u)) : U0;
  return {state:{R,u}, release};
}

function runSimulation(cfg){
  const T=Math.round(cfg.duration_s*1000), dt=1, n=T;
  const spikes=poissonSpikes(cfg.rate_hz, T, cfg.burstFactor);
  let stPC={R:1,u:cfg.pc.U0}, stIN={R:1,u:cfg.in.U0};
  const VmPC=new Float32Array(n).fill(0), VmIN=new Float32Array(n).fill(0);
  const gEpc=new Float32Array(n).fill(0), gEin=new Float32Array(n).fill(0), gIpc=new Float32Array(n).fill(0);
  const tauSyn=10, tauPC=20, tauIN=10, thr=1, reset=0;
  const inSpikeTimes=[], pcSpikeTimes=[];
  function addKernel(arr,t0,amp){ for(let t=t0;t<Math.min(n,t0+10*tauSyn);t++){ arr[t]+= amp*Math.exp(-(t-t0)/tauSyn); } }

  for (let i=0;i<spikes.length;i++){
    const t=spikes[i], isi=(i===0)? t : (t-spikes[i-1]);
    const stpPC=TM_on_spike(stPC, cfg.pc, isi); stPC=stpPC.state; addKernel(gEpc, t, cfg.wPC*stpPC.release);
    const stpIN=TM_on_spike(stIN, cfg.in, isi); stIN=stpIN.state; addKernel(gEin, t, cfg.wIN*stpIN.release);
  }
  for (let t=1;t<n;t++){
    VmIN[t] = VmIN[t-1] + dt*((-VmIN[t-1])/tauIN + gEin[t]);
    if (VmIN[t]>=thr){ inSpikeTimes.push(t); VmIN[t]=reset; addKernel(gIpc, Math.min(n-1, t+cfg.delay_ms), cfg.gIP); }
    VmPC[t] = VmPC[t-1] + dt*((-VmPC[t-1])/tauPC + gEpc[t] - gIpc[t]);
    if (VmPC[t]>=thr){ pcSpikeTimes.push(t); VmPC[t]=reset; }
  }
  return {VmPC:[...VmPC],VmIN:[...VmIN],gEpc:[...gEpc],gEin:[...gEin],gIpc:[...gIpc],pcSpikeTimes,inSpikeTimes,T};
}

let chartVm, chartSyn, chartInh;
function initCharts(){
  chartVm = new Chart(document.getElementById('chartVm'), { type:'line', data:{ labels:[], datasets:[{label:'PC Vm',data:[],borderWidth:2},{label:'IN Vm',data:[],borderWidth:2}]}, options:{ responsive:true } });
  chartSyn = new Chart(document.getElementById('chartSyn'), { type:'line', data:{ labels:[], datasets:[{label:'PC excitatory drive',data:[],borderWidth:2},{label:'IN excitatory drive',data:[],borderWidth:2}]}, options:{ responsive:true } });
  chartInh = new Chart(document.getElementById('chartInh'), { type:'line', data:{ labels:[], datasets:[{label:'Inhibition → PC',data:[],borderWidth:2}]}, options:{ responsive:true } });
}

function updateCharts(sim){
  const labels=Array.from({length:sim.T},(_,i)=>i);
  chartVm.data.labels=labels; chartVm.data.datasets[0].data=sim.VmPC; chartVm.data.datasets[1].data=sim.VmIN; chartVm.update();
  chartSyn.data.labels=labels; chartSyn.data.datasets[0].data=sim.gEpc; chartSyn.data.datasets[1].data=sim.gEin; chartSyn.update();
  chartInh.data.labels=labels; chartInh.data.datasets[0].data=sim.gIpc; chartInh.update();
  function renderSpikes(divId, arr){ const div=document.getElementById(divId); div.innerHTML=''; arr.forEach(()=>{const s=document.createElement('span'); s.className='spike'; div.appendChild(s);}); const lbl=document.createElement('div'); lbl.className='mt-1'; lbl.textContent=`${arr.length} spikes`; div.appendChild(lbl);} 
  renderSpikes('pcSpikes', sim.pcSpikeTimes); renderSpikes('inSpikes', sim.inSpikeTimes);
}

function gatherConfig(){
  const duration_s=parseFloat(document.getElementById('dur').value);
  return { duration_s, rate_hz:parseFloat(document.getElementById('rate').value), burstFactor:parseFloat(document.getElementById('burst').value), delay_ms:parseFloat(document.getElementById('delay').value), gIP:parseFloat(document.getElementById('gip').value), wPC:parseFloat(document.getElementById('wpc').value), wIN:parseFloat(document.getElementById('win').value), pc:{ U0:parseFloat(document.getElementById('Upc').value), tau_rec:parseFloat(document.getElementById('trpc').value), tau_facil:parseFloat(document.getElementById('tfpc').value)}, in:{ U0:parseFloat(document.getElementById('Uin').value), tau_rec:parseFloat(document.getElementById('trin').value), tau_facil:parseFloat(document.getElementById('tfin').value)} };
}

function bindLabels(){
  const pairs=[['rate','rateVal','Hz'],['dur','durVal',''],['burst','burstVal','×'],['Upc','UpcVal',''],['tfpc','tfpcVal',''],['trpc','trpcVal',''],['wpc','wpcVal',''],['Uin','UinVal',''],['tfin','tfinVal',''],['trin','trinVal',''],['win','winVal',''],['gip','gipVal',''],['delay','dlyVal','']];
  pairs.forEach(([id,lab,suf])=>{ const el=document.getElementById(id), labEl=document.getElementById(lab); const fmt=v=> (id==='dur'?parseFloat(v).toFixed(1):v)+(suf||''); labEl.textContent=fmt(el.value); el.addEventListener('input',()=> labEl.textContent=fmt(el.value)); });
}

function bindPresets(){
  document.getElementById('presetBg').addEventListener('click',()=>{ document.getElementById('rate').value=3; document.getElementById('burst').value=1; document.getElementById('gip').value=2.0; document.getElementById('Upc').value=0.12; document.getElementById('tfpc').value=800; document.getElementById('trpc').value=120; document.getElementById('Uin').value=0.55; document.getElementById('tfin').value=0; document.getElementById('trin').value=600; document.getElementById('wpc').value=1.0; document.getElementById('win').value=1.0; bindLabels(); run(); });
  document.getElementById('presetBurst').addEventListener('click',()=>{ document.getElementById('rate').value=8; document.getElementById('burst').value=6; document.getElementById('gip').value=1.2; document.getElementById('Upc').value=0.15; document.getElementById('tfpc').value=900; document.getElementById('trpc').value=100; document.getElementById('Uin').value=0.4; document.getElementById('tfin').value=50; document.getElementById('trin').value=800; document.getElementById('wpc').value=1.3; document.getElementById('win').value=1.0; bindLabels(); run(); });
  document.getElementById('reset').addEventListener('click',()=>{ window.location.reload(); });
}

function run(){ const cfg=gatherConfig(); const sim=runSimulation(cfg); updateCharts(sim); }

window.addEventListener('DOMContentLoaded', ()=>{ initCharts(); bindLabels(); bindPresets(); document.getElementById('run').addEventListener('click', run); run(); });
</script>
</body>
</html>